<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Window Remote (BLE)</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    .row { display:flex; gap: 12px; margin-bottom: 12px; }
    button { padding: 14px 18px; font-size: 18px; border-radius: 12px; border: 1px solid #ccc; }
    #log { height: 180px; border: 1px solid #ddd; padding: 8px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background:#fafafa; }
    .big { font-size: 22px; }
  </style>
</head>
<body>
  <h1>ESP32 Window Remote</h1>
  <p>Kết nối BLE theo chuẩn <b>Nordic UART</b>. Nút: LÊN, DỪNG, XUỐNG. Nhấn <i>Connect</i> và chọn <b>ESP32-Window</b>.</p>
  <div class="row">
    <button id="btnConnect" class="big">Connect</button>
    <button id="btnDisconnect">Disconnect</button>
  </div>
  <div class="row">
    <button id="btnUp" class="big">⬆️ LÊN</button>
    <button id="btnStop" class="big">⏹️ DỪNG</button>
    <button id="btnDown" class="big">⬇️ XUỐNG</button>
    <button id="btnQuery">Trạng thái</button>
  </div>
  <div id="log"></div>

  <script>
    const NUS_SERVICE = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
    const NUS_RX = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // write
    const NUS_TX = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // notify

    let device, server, service, rxChar, txChar;

    function log(msg) {
      const box = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      box.innerText += `[${time}] ${msg}\n`;
      box.scrollTop = box.scrollHeight;
    }

    async function connect() {
      try {
        device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: 'ESP32' }],
          optionalServices: [NUS_SERVICE]
        });
        device.addEventListener('gattserverdisconnected', onDisconnected);

        server = await device.gatt.connect();
        service = await server.getPrimaryService(NUS_SERVICE);
        rxChar = await service.getCharacteristic(NUS_RX);
        txChar = await service.getCharacteristic(NUS_TX);
        await txChar.startNotifications();
        txChar.addEventListener('characteristicvaluechanged', handleNotify);
        log('Connected');
      } catch (e) {
        log('Connect error: ' + e);
      }
    }

    function onDisconnected() { log('Disconnected'); }

    function handleNotify(event) {
      const v = new TextDecoder().decode(event.target.value);
      log('Status: ' + v);
    }

    async function sendCmd(cmd) {
      if (!rxChar) { log('Chưa kết nối'); return; }
      const data = new TextEncoder().encode(cmd);
      try {
        await rxChar.writeValue(data);
        log('Sent: ' + cmd);
      } catch (e) {
        log('Send error: ' + e);
      }
    }

    document.getElementById('btnConnect').onclick = connect;
    document.getElementById('btnDisconnect').onclick = async () => {
      try { if (device && device.gatt.connected) await device.gatt.disconnect(); } catch {}
    };
    document.getElementById('btnUp').onclick = () => sendCmd('F');
    document.getElementById('btnStop').onclick = () => sendCmd('F');
    document.getElementById('btnDown').onclick = () => sendCmd('D');
    document.getElementById('btnQuery').onclick = () => sendCmd('Q');

    if (!('bluetooth' in navigator)) {
      log('Trình duyệt không hỗ trợ Web Bluetooth. Dùng Chrome/Edge trên Android.');
    } else {
      log('Web Bluetooth sẵn sàng. Nhấn Connect để bắt đầu.');
    }
  </script>
</body>
</html>
