<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DHT11 Dashboard</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin:0; font-family:sans-serif;
      background: linear-gradient(135deg,#4facfe,#00f2fe);
      min-height:100vh;
      display:flex; justify-content:center; align-items:center;
    }

    /* LOGIN 3D */
    #loginForm {
      width:300px; padding:40px;
      border-radius:20px;
      background: rgba(255,255,255,0.15);
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      backdrop-filter: blur(12px);
      border:1px solid rgba(255,255,255,0.3);
      text-align:center;
      color:#fff;
      transform: perspective(1000px) rotateY(0deg) rotateX(0deg);
      transition: transform 0.5s;
    }
    #loginForm:hover { transform: perspective(1000px) rotateY(10deg) rotateX(5deg); }
    #loginForm h2 { margin-bottom:20px; font-size:26px; font-weight:bold; text-shadow:0 3px 6px rgba(0,0,0,0.4); }
    #loginForm input {
      width: 80%; padding:12px; margin:12px auto; display:block;
      border:none; outline:none; border-radius:10px; font-size:16px;
      text-align:center;
      box-shadow: inset 2px 2px 6px rgba(0,0,0,0.3),
                  inset -2px -2px 6px rgba(255,255,255,0.3);
    }
    #loginForm button {
      padding:12px 25px; border:none; border-radius:12px;
      background: linear-gradient(135deg,#667eea,#764ba2);
      color:#fff; font-weight:bold; font-size:16px;
      cursor:pointer; margin-top:15px;
      box-shadow:0 4px 15px rgba(0,0,0,0.4);
      transition: transform 0.2s;
    }
    #loginForm button:hover { transform:scale(1.05); }
    #errorMsg { margin-top:12px; color:yellow; font-weight:bold; text-shadow:0 1px 3px rgba(0,0,0,0.7); }

    /* DASHBOARD */
    #dashboard { display:none; width:100%; }
    h1 { background:#3f51b5; color:#fff; padding:15px; margin:0; text-align:center; }
    .status { margin:15px; font-weight:bold; text-align:center; }
    .cards { display:flex; justify-content:center; gap:40px; margin-top:30px; flex-wrap:wrap; }
    .card {
      background:#fff; padding:20px; border-radius:15px;
      box-shadow:0 4px 10px rgba(0,0,0,0.1); width:160px; text-align:center;
    }
    .label { font-size:20px; font-weight:bold; margin-bottom:10px; }
    .temp { color:red; }
    .humi { color:blue; }
    .value { font-size:40px; font-weight:bold; }

    .relay { margin-top:40px; text-align:center; }
    .btn {
      font-size:18px; padding:12px 25px; margin:10px;
      border:none; border-radius:10px; cursor:pointer;
      color:#fff; font-weight:bold;
    }
    .on { background:#22c55e; }
    .off { background:#ef4444; }

    .chart-container {
      width: 90%; max-width: 800px;
      margin: 40px auto;
      background: #fff; padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    /* ·ªêNG 3D */
    .tubes { display:flex; justify-content:center; gap:60px; margin-top:40px; }
    .tube {
      width:60px; height:200px;
      background:linear-gradient(to right,#ccc,#eee,#ccc);
      border-radius:30px;
      position:relative; overflow:hidden;
      box-shadow: inset -5px -5px 10px rgba(255,255,255,0.6),
                  inset 5px 5px 15px rgba(0,0,0,0.2),
                  0 8px 20px rgba(0,0,0,0.3);
    }
    .fill {
      position:absolute; bottom:0; width:100%;
      border-radius:30px;
      transition:height 0.5s;
    }
    .tube-label {
      text-align:center; margin-top:10px; font-weight:bold; color:#333;
    }
  </style>
</head>
<body>

  <!-- üîê FORM LOGIN -->
  <div id="loginForm">
    <h2>üîê ƒêƒÉng nh·∫≠p</h2>
    <input type="password" id="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u"/>
    <button onclick="checkLogin()">ƒêƒÉng nh·∫≠p</button>
    <div id="errorMsg"></div>
  </div>

  <!-- üìä DASHBOARD -->
  <div id="dashboard">
    <h1>DHT11 Dashboard</h1>
    <div class="status" id="status">üî¥ Ch∆∞a k·∫øt n·ªëi MQTT</div>

    <div class="cards">
      <div class="card">
        <div class="label temp">üåû Nhi·ªát ƒë·ªô</div>
        <div class="value" id="temp">--</div>
      </div>
      <div class="card">
        <div class="label humi">‚ùÑÔ∏è ƒê·ªô ·∫©m</div>
        <div class="value" id="humi">--</div>
      </div>
    </div>

    <!-- ·ªêng 3D -->
    <div class="tubes">
      <div>
        <div class="tube"><div class="fill" id="tempFill" style="background:red;height:0%"></div></div>
        <div class="tube-label">Nhi·ªát ƒë·ªô</div>
      </div>
      <div>
        <div class="tube"><div class="fill" id="humiFill" style="background:blue;height:0%"></div></div>
        <div class="tube-label">ƒê·ªô ·∫©m</div>
      </div>
    </div>

    <div class="relay">
      <h2>ƒêi·ªÅu khi·ªÉn Relay</h2>
      <button class="btn on" id="btnOn">B·∫¨T</button>
      <button class="btn off" id="btnOff">T·∫ÆT</button>
      <p>Tr·∫°ng th√°i relay: <span id="relayStatus">--</span></p>
    </div>

    <div class="chart-container">
      <h2>L·ªãch s·ª≠ Nhi·ªát ƒë·ªô & ƒê·ªô ·∫©m</h2>
      <canvas id="dhtChart"></canvas>
    </div>
  </div>

  <script>
    // ‚úÖ ƒêƒÉng nh·∫≠p
    const PASSWORD = "8888";
    function checkLogin(){
      const pass = document.getElementById("password").value;
      if(pass === PASSWORD){
        document.getElementById("loginForm").style.display="none";
        document.getElementById("dashboard").style.display="block";
        startMQTT(); // üëâ b·∫Øt ƒë·∫ßu khi login th√†nh c√¥ng
      } else {
        document.getElementById("errorMsg").textContent="‚ùå Sai m·∫≠t kh·∫©u!";
      }
    }

    // ‚úÖ MQTT + Dashboard
    function startMQTT(){
      const options = {
        username: "thanh1996",
        password: "14121996Th",
        protocol: "wss",
        port: 8884,
        clientId: "webClient_" + Math.random().toString(16).substr(2, 8)
      };
      const host = "wss://21a3db3a20cb4f279935ea81af04ba01.s1.eu.hivemq.cloud:8884/mqtt";
      const client = mqtt.connect(host, options);

      const statusEl = document.getElementById("status");
      const tempEl = document.getElementById("temp");
      const humiEl = document.getElementById("humi");
      const relayStatusEl = document.getElementById("relayStatus");
      const tempFill = document.getElementById("tempFill");
      const humiFill = document.getElementById("humiFill");

      const ctx = document.getElementById("dhtChart").getContext("2d");
      const dhtChart = new Chart(ctx,{
        type:"line",
        data:{ labels:[], datasets:[
          {label:"Nhi·ªát ƒë·ªô (¬∞C)",borderColor:"red",data:[],fill:false},
          {label:"ƒê·ªô ·∫©m (%)",borderColor:"blue",data:[],fill:false}
        ]},
        options:{responsive:true,animation:false,scales:{y:{beginAtZero:true}}}
      });
      const maxPoints=20;

      function addData(temp,humi){
        const now=new Date().toLocaleTimeString();
        if(dhtChart.data.labels.length>=maxPoints){
          dhtChart.data.labels.shift();
          dhtChart.data.datasets[0].data.shift();
          dhtChart.data.datasets[1].data.shift();
        }
        dhtChart.data.labels.push(now);
        dhtChart.data.datasets[0].data.push(temp);
        dhtChart.data.datasets[1].data.push(humi);
        dhtChart.update();
      }

      client.on("connect",()=>{
        statusEl.textContent="üü¢ ƒê√£ k·∫øt n·ªëi MQTT";
        client.subscribe("esp8266/dht11/temp");
        client.subscribe("esp8266/dht11/humi");
        client.subscribe("esp8266/relay1/status");
      });
      client.on("error",(err)=>{ statusEl.textContent="‚ùå L·ªói: "+err; });

      let latestTemp=null, latestHumi=null;
      client.on("message",(topic,message)=>{
        const msg=message.toString();
        if(topic==="esp8266/dht11/temp"){
          tempEl.textContent=msg+"¬∞C";
          latestTemp=parseFloat(msg);
          tempFill.style.height=Math.min(100,(latestTemp/50*100))+"%";
        }
        if(topic==="esp8266/dht11/humi"){
          humiEl.textContent=msg+"%";
          latestHumi=parseFloat(msg);
          humiFill.style.height=Math.min(100,latestHumi)+"%";
        }
        if(topic==="esp8266/relay1/status"){ relayStatusEl.textContent=msg; }
        if(latestTemp!==null && latestHumi!==null){
          addData(latestTemp,latestHumi);
          latestTemp=latestHumi=null;
        }
      });

      document.getElementById("btnOn").addEventListener("click",()=>{ client.publish("esp8266/relay1","on"); });
      document.getElementById("btnOff").addEventListener("click",()=>{ client.publish("esp8266/relay1","off"); });
    }
  </script>
</body>
</html>
