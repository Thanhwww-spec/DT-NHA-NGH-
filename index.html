<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>DHT11 Dashboard</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1 {
      background: #3b82f6;
      padding: 15px;
      margin: 0;
      border-radius: 5px;
    }
    .status {
      margin: 10px;
      font-weight: bold;
    }
    .card {
      display: inline-block;
      background: #222;
      margin: 15px;
      padding: 20px;
      border-radius: 15px;
      width: 150px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.6);
    }
    .card h2 {
      margin: 10px 0;
    }
    .gauge {
      margin: 20px auto;
      width: 60px;
      height: 150px;
      border-radius: 30px;
      background: #333;
      position: relative;
      overflow: hidden;
      box-shadow: inset 0 0 10px #000;
    }
    .fill {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: linear-gradient(to top, red, #f87171);
      transition: height 0.5s;
    }
    .fill.humi {
      background: linear-gradient(to top, blue, #60a5fa);
    }
    .relay-btn {
      margin: 10px;
      padding: 10px 25px;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: white;
    }
    .on { background: green; }
    .off { background: red; }
  </style>
</head>
<body>
  <h1>DHT11 Dashboard</h1>
  <div class="status" id="mqttStatus">üî¥ M·∫•t k·∫øt n·ªëi</div>

  <div class="card">
    <h2>üå° Nhi·ªát ƒë·ªô</h2>
    <div id="tempValue">--</div>
    <div class="gauge"><div id="tempFill" class="fill"></div></div>
  </div>

  <div class="card">
    <h2>üíß ƒê·ªô ·∫©m</h2>
    <div id="humiValue">--</div>
    <div class="gauge"><div id="humiFill" class="fill humi"></div></div>
  </div>

  <div class="card" style="width:300px;">
    <h2>ƒêi·ªÅu khi·ªÉn Relay</h2>
    <div id="relayStatus">Tr·∫°ng th√°i: --</div>
    <button class="relay-btn on" id="btnOn">B·∫¨T</button>
    <button class="relay-btn off" id="btnOff">T·∫ÆT</button>
  </div>

  <script>
    // --- C·∫•u h√¨nh MQTT (Websocket HiveMQ) ---
    const options = {
      username: "thanh1996",
      password: "14121996Th",
      clean: true,
      connectTimeout: 4000,
      reconnectPeriod: 2000
    };

    const client = mqtt.connect("wss://21a3db3a20cb4f279935ea81af04ba01.s1.eu.hivemq.cloud:8884/mqtt", options);

    const mqttStatus = document.getElementById("mqttStatus");
    const tempValue = document.getElementById("tempValue");
    const humiValue = document.getElementById("humiValue");
    const relayStatus = document.getElementById("relayStatus");
    const tempFill = document.getElementById("tempFill");
    const humiFill = document.getElementById("humiFill");

    // --- S·ª± ki·ªán k·∫øt n·ªëi ---
    client.on("connect", () => {
      mqttStatus.textContent = "üü¢ ƒê√£ k·∫øt n·ªëi MQTT";
      client.subscribe("esp8266/availability");
      client.subscribe("esp8266/dht11/temp");
      client.subscribe("esp8266/dht11/humi");
      client.subscribe("esp8266/relay1/status");
    });

    client.on("reconnect", () => {
      mqttStatus.textContent = "üü° ƒêang th·ª≠ k·∫øt n·ªëi l·∫°i...";
    });

    client.on("offline", () => {
      mqttStatus.textContent = "üî¥ M·∫•t k·∫øt n·ªëi";
      tempValue.textContent = "‚ùå L·ªói c·∫£m bi·∫øn";
      humiValue.textContent = "‚ùå L·ªói c·∫£m bi·∫øn";
    });

    // --- X·ª≠ l√Ω d·ªØ li·ªáu nh·∫≠n ---
    client.on("message", (topic, message) => {
      const msg = message.toString();
      if (topic === "esp8266/availability") {
        if (msg === "online") {
          mqttStatus.textContent = "üü¢ ESP Online";
        } else {
          mqttStatus.textContent = "üî¥ ESP Offline";
          tempValue.textContent = "‚ùå L·ªói c·∫£m bi·∫øn";
          humiValue.textContent = "‚ùå L·ªói c·∫£m bi·∫øn";
        }
      }
      if (topic === "esp8266/dht11/temp") {
        if (msg === "error") {
          tempValue.textContent = "‚ùå L·ªói c·∫£m bi·∫øn";
          tempFill.style.height = "0%";
        } else {
          tempValue.textContent = msg + " ¬∞C";
          tempFill.style.height = Math.min(parseFloat(msg), 100) + "%";
        }
      }
      if (topic === "esp8266/dht11/humi") {
        if (msg === "error") {
          humiValue.textContent = "‚ùå L·ªói c·∫£m bi·∫øn";
          humiFill.style.height = "0%";
        } else {
          humiValue.textContent = msg + " %";
          humiFill.style.height = Math.min(parseFloat(msg), 100) + "%";
        }
      }
      if (topic === "esp8266/relay1/status") {
        relayStatus.textContent = "Tr·∫°ng th√°i: " + msg.toUpperCase();
      }
    });

    // --- ƒêi·ªÅu khi·ªÉn Relay ---
    document.getElementById("btnOn").onclick = () => {
      client.publish("esp8266/relay1", "on");
      relayStatus.textContent = "Tr·∫°ng th√°i: ON";
    };
    document.getElementById("btnOff").onclick = () => {
      client.publish("esp8266/relay1", "off");
      relayStatus.textContent = "Tr·∫°ng th√°i: OFF";
    };
  </script>
</body>
</html>
