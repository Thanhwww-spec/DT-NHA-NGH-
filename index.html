<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>📒 Quản Lý Mượn Tiền (Offline trước - Sync online)</title>
<style>
  :root{ --c1:#8fd3f4; --c2:#84fab0; --c3:#00c6ff; --c4:#009acd; }
  *{ box-sizing: border-box; }

  /* ===== NỀN HẠT BAY (Canvas phủ toàn màn) ===== */
  #bg {
    position: fixed; inset: 0; width: 100%; height: 100%;
    z-index: -1; background: linear-gradient(135deg, var(--c1), var(--c2));
  }

  body{ margin:0; font-family: system-ui, Arial, sans-serif; color:#fff; overflow-x:hidden; }

  /* ===== LOGIN MODAL (căn giữa) ===== */
  #loginModal{
    position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
    background: rgba(0,0,0,.45); z-index: 10;
  }
  .login-box{
    width: 92%; max-width: 340px;
    background: rgba(255,255,255,.14);
    border: 1px solid rgba(255,255,255,.3);
    border-radius: 16px; backdrop-filter: blur(16px);
    padding: 22px; text-align: center;
    box-shadow: 0 16px 40px rgba(0,0,0,.45);
  }
  .login-box h2{ margin: 0 0 8px; }
  .login-desc{ margin: 2px 0 12px; opacity: .9; }

  .login-input, .login-btn{
    width: 100%; padding: 12px; border: none; border-radius: 10px; font-size: 15px;
  }
  .login-input{ background: rgba(255,255,255,.94); color: #111; margin-bottom: 10px; }
  .login-btn{
    background: linear-gradient(145deg, var(--c3), #55e0ff);
    color: #fff; font-weight: 700; cursor: pointer;
    box-shadow: 0 8px 18px rgba(0,0,0,.25);
    transition: transform .15s, box-shadow .15s;
  }
  .login-btn:hover{ transform: translateY(-2px); box-shadow: 0 12px 24px rgba(0,0,0,.28); }
  .hint{
    margin-top:8px; font-size:12px; opacity:.85;
    background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.35);
    padding:6px 10px; border-radius:20px; display:inline-block;
  }

  /* ===== APP ===== */
  .container{ max-width: 900px; margin: 0 auto; padding: 12px; display: none; }
  h1{ font-size: 20px; text-align: center; margin: 16px 0 12px; text-shadow: 1px 1px 3px rgba(0,0,0,.25); }

  .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .badge{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:20px; font-size:12px; font-weight:700;
    background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.35);
  }
  .badge.online{ background: rgba(0,200,0,.18); color:#0a0; }
  .badge.offline{ background: rgba(255,140,0,.18); color:#b35d00; }
  .badge.sync{ background: rgba(0,102,255,.18); color:#0046a8; }

  .card{
    backdrop-filter: blur(8px);
    background: rgba(255,255,255,.12);
    border:1px solid rgba(255,255,255,.25);
    border-radius:14px; box-shadow:0 12px 30px rgba(0,0,0,.25);
    padding:12px;
  }

  .grid{ display: grid; grid-template-columns: 1fr; gap: 8px; }
  input, button{ width:100%; padding:10px; border:none; border-radius:8px; font-size:14px; }
  input{ background: rgba(255,255,255,.95); color:#111; }
  button{
    background: linear-gradient(145deg, var(--c3), #55e0ff); color: #fff; font-weight: 700; cursor: pointer;
    box-shadow: 0 6px 14px rgba(0,0,0,.25); transition: transform .15s, box-shadow .15s;
  }
  button:hover{ transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,.28); }

  table{ width:100%; border-collapse: collapse; background: #fff; color: #111; border-radius:10px; overflow:hidden; }
  th, td{ border:1px solid #e7e7e7; padding:8px; text-align:center; font-size:14px; }
  th{ background: linear-gradient(145deg, var(--c3), #5fe1ff); color:#fff; }
  tr:nth-child(even){ background:#fafafa; }
  tr:hover td{ background:#eef9ff; }
  .action-btn{ border:none; background:none; cursor:pointer; font-size:18px; padding:4px; }

  @media (min-width:560px){
    .grid{ grid-template-columns: repeat(5, 1fr); }
    .grid > *:nth-child(1){ grid-column: span 1; } /* date */
    .grid > *:nth-child(2){ grid-column: span 2; } /* name */
    .grid > *:nth-child(3){ grid-column: span 1; } /* amount */
    .grid > *:nth-child(4){ grid-column: span 1; } /* interest */
    .grid > *:nth-child(5){ grid-column: span 5; } /* button */
  }
</style>
</head>
<body>
<canvas id="bg"></canvas>

<!-- ===== ĐĂNG NHẬP (giữa màn hình) ===== -->
<div id="loginModal">
  <div class="login-box">
    <h2>🔐 Đăng nhập</h2>
    <div class="login-desc">Nhập mật khẩu để truy cập hệ thống</div>
    <input type="password" id="loginPassword" class="login-input" placeholder="Mật khẩu" />
    <button id="btnLogin" class="login-btn">Đăng nhập</button>
    <div class="hint">Gợi ý: 123456</div>
  </div>
</div>

<!-- ===== ỨNG DỤNG ===== -->
<div class="container" id="app">
  <h1>📒 Quản Lý Mượn Tiền</h1>

  <div class="row" style="justify-content:space-between; margin:6px 0 10px;">
    <div id="netBadge" class="badge offline">● Offline – lưu cục bộ</div>
    <div id="syncBadge" class="badge" style="display:none;">⏳ Đang đồng bộ…</div>
  </div>

  <div class="card" style="margin-bottom:12px;">
    <div class="grid">
      <input id="date" type="date" />
      <input id="name" placeholder="Tên người mượn" />
      <input id="amount" type="number" placeholder="Số tiền" />
      <input id="interest" type="number" placeholder="Tiền lãi" />
      <button id="btnAdd">➕ Thêm</button>
    </div>
  </div>

  <h3 style="margin:6px 0;">Danh sách</h3>
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Ngày</th>
          <th>Tên</th>
          <th>Số tiền</th>
          <th>Tiền lãi</th>
          <th>Sửa</th>
          <th>Xóa</th>
        </tr>
      </thead>
      <tbody id="list"></tbody>
    </table>
  </div>
</div>

<script type="module">
  /************ FIREBASE (dùng khi có mạng để đồng bộ) ************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import {
    getFirestore, doc, setDoc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAJnH6cnUcGKh62gRvxCeGf9PMuEq9IP6Y",
    authDomain: "maylanh-458b5.firebaseapp.com",
    projectId: "maylanh-458b5",
    storageBucket: "maylanh-458b5.appspot.com",
    messagingSenderId: "150037681682",
    appId: "1:150037681682:web:4a283f58a8b6b1348b413b"
  };
  let db = null;
  try {
    const fbApp = initializeApp(firebaseConfig);
    db = getFirestore(fbApp);
  } catch(e){ console.warn("Firebase init:", e.message); }

  /************ MẬT KHẨU ************/
  const PASSWORD = "123456";

  /************ TIỆN ÍCH NGÀY ************/
  const toDisplay = iso => { if(!iso) return ""; const [y,m,d]=iso.split("-"); return `${d}-${m}-${y}`; };
  const toIso = disp => { const [d,m,y]=disp.split("-"); return `${y}-${m}-${d}`; };

  /************ LOCAL STORAGE ************/
  const LS_KEY = "loan_records_v1";
  const OPS_KEY = "loan_ops_v1"; // hàng đợi đồng bộ

  function readLocal(){
    try { return JSON.parse(localStorage.getItem(LS_KEY)) || []; }
    catch { return []; }
  }
  function writeLocal(arr){
    localStorage.setItem(LS_KEY, JSON.stringify(arr));
  }
  function readOps(){
    try { return JSON.parse(localStorage.getItem(OPS_KEY)) || []; }
    catch { return []; }
  }
  function writeOps(arr){
    localStorage.setItem(OPS_KEY, JSON.stringify(arr));
  }

  function uid(){
    return "id_" + Date.now().toString(36) + Math.random().toString(36).slice(2,8);
  }

  /************ UI TRẠNG THÁI MẠNG ************/
  const netBadge = document.getElementById("netBadge");
  const syncBadge = document.getElementById("syncBadge");
  function updateNetBadge(){
    if(navigator.onLine){
      netBadge.textContent = "✓ Online – sẽ đồng bộ";
      netBadge.className = "badge online";
      syncNow();
    }else{
      netBadge.textContent = "● Offline – lưu cục bộ";
      netBadge.className = "badge offline";
    }
  }
  window.addEventListener("online", updateNetBadge);
  window.addEventListener("offline", updateNetBadge);

  /************ RENDER BẢNG ************/
  const listEl = document.getElementById("list");
  function render(){
    const data = readLocal()
      .slice()
      .sort((a,b)=> (b.dateIso||"").localeCompare(a.dateIso||""));
    let rows = "";
    for(const x of data){
      rows += `
        <tr>
          <td>${x.date || toDisplay(x.dateIso)}</td>
          <td>${x.name || ""}</td>
          <td>${Number(x.amount||0).toLocaleString()} đ</td>
          <td>${Number(x.interest||0).toLocaleString()} đ</td>
          <td><button class="action-btn" title="Sửa" onclick="editLoan('${x.id}')">✏️</button></td>
          <td><button class="action-btn" title="Xóa" onclick="deleteLoan('${x.id}')">🗑️</button></td>
        </tr>
      `;
    }
    listEl.innerHTML = rows || `<tr><td colspan="6">Chưa có dữ liệu</td></tr>`;
  }

  /************ THÊM / SỬA / XÓA (offline-first) ************/
  document.getElementById("btnAdd").onclick = ()=>{
    const dateIso = (document.getElementById("date").value||"").trim();
    const name = (document.getElementById("name").value||"").trim();
    const amount = Number(document.getElementById("amount").value||0);
    const interest = Number(document.getElementById("interest").value||0);
    if(!dateIso || !name || !amount){ alert("Vui lòng nhập đủ Ngày/Tên/Số tiền"); return; }

    const rec = { id: uid(), dateIso, date: toDisplay(dateIso), name, amount, interest };
    const data = readLocal(); data.push(rec); writeLocal(data);
    enqueueSet(rec);
    document.getElementById("name").value = "";
    document.getElementById("amount").value = "";
    document.getElementById("interest").value = "";
    render(); updateNetBadge();
  };

  window.editLoan = (id)=>{
    const pass = prompt("Nhập mật khẩu để sửa:");
    if(pass !== PASSWORD) return alert("Sai mật khẩu!");

    const data = readLocal();
    const idx = data.findIndex(x=>x.id===id);
    if(idx<0) return;

    const cur = data[idx];
    const newDateDisp = prompt("Ngày (DD-MM-YYYY):", cur.date) || cur.date;
    const newName = prompt("Tên:", cur.name) || cur.name;
    const newAmount = Number(prompt("Số tiền:", cur.amount) || cur.amount);
    const newInterest = Number(prompt("Tiền lãi:", cur.interest) || cur.interest);

    const updated = {
      ...cur,
      date: newDateDisp,
      dateIso: toIso(newDateDisp),
      name: newName,
      amount: newAmount,
      interest: newInterest
    };
    data[idx] = updated; writeLocal(data);
    enqueueSet(updated);
    render(); updateNetBadge();
  };

  window.deleteLoan = (id)=>{
    const pass = prompt("Nhập mật khẩu để xóa:");
    if(pass !== PASSWORD) return alert("Sai mật khẩu!");
    if(!confirm("Chắc chắn xóa dòng này?")) return;

    const data = readLocal().filter(x=>x.id!==id);
    writeLocal(data);
    enqueueDelete(id);
    render(); updateNetBadge();
  };

  function enqueueSet(rec){
    const ops = readOps();
    ops.push({ type:"set", id: rec.id, data: rec, ts: Date.now() });
    writeOps(ops);
  }
  function enqueueDelete(id){
    const ops = readOps();
    ops.push({ type:"delete", id, ts: Date.now() });
    writeOps(ops);
  }

  /************ ĐỒNG BỘ LÊN FIRESTORE (nếu online) ************/
  async function syncNow(){
    const ops = readOps();
    if(!ops.length) { syncBadge.style.display = "none"; return; }
    if(!navigator.onLine || !db){ syncBadge.style.display = "none"; return; }

    syncBadge.style.display = "inline-flex";
    // xử lý từng tác vụ theo thứ tự
    while(ops.length && navigator.onLine){
      const op = ops[0];
      try{
        const ref = doc(db, "loans", op.id); // dùng id local làm id cloud
        if(op.type==="set"){
          await setDoc(ref, op.data);
        }else if(op.type==="delete"){
          await deleteDoc(ref);
        }
        ops.shift(); // remove done
        writeOps(ops);
      }catch(e){
        console.warn("Sync error:", e.message);
        break; // dừng, lát nữa thử lại
      }
    }
    syncBadge.style.display = ops.length ? "inline-flex" : "none";
  }

  // thử sync khi mở app, khi online lại
  setInterval(syncNow, 4000);

  /************ LOGIN ************/
  const loginModal = document.getElementById("loginModal");
  const app = document.getElementById("app");
  document.getElementById("btnLogin").onclick = ()=>{
    const pass = document.getElementById("loginPassword").value.trim();
    if(pass === PASSWORD){
      loginModal.style.display = "none";
      app.style.display = "block";
      updateNetBadge();
      render();
    }else{
      alert("Sai mật khẩu!");
    }
  };
  document.getElementById("loginPassword").addEventListener("keydown", e=>{
    if(e.key==="Enter") document.getElementById("btnLogin").click();
  });

  /************ NỀN HẠT BAY (canvas, không dùng CDN) ************/
  const canvas = document.getElementById("bg");
  const ctx = canvas.getContext("2d");
  let W=0,H=0, particles=[];
  function resize(){
    W = canvas.width = innerWidth * devicePixelRatio;
    H = canvas.height = innerHeight * devicePixelRatio;
  }
  addEventListener("resize", resize); resize();

  function initParticles(){
    const count = Math.min(120, Math.floor((innerWidth*innerHeight)/12000));
    particles = [];
    for(let i=0;i<count;i++){
      particles.push({
        x: Math.random()*W,
        y: Math.random()*H,
        vx: (Math.random()*2-1)*0.15*devicePixelRatio,
        vy: (Math.random()*2-1)*0.15*devicePixelRatio,
        r: (Math.random()*2+0.8)*devicePixelRatio
      });
    }
  }
  initParticles();

  function step(){
    ctx.clearRect(0,0,W,H);

    // nền gradient nhẹ (đỡ trống khi offline)
    const g = ctx.createLinearGradient(0,0,W,H);
    g.addColorStop(0,"#8fd3f4");
    g.addColorStop(1,"#84fab0");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    // vẽ và cập nhật hạt
    ctx.globalAlpha = 0.9;
    for(const p of particles){
      p.x += p.vx; p.y += p.vy;
      if(p.x<0) p.x=W; if(p.x>W) p.x=0;
      if(p.y<0) p.y=H; if(p.y>H) p.y=0;

      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fillStyle = "rgba(255,255,255,0.85)";
      ctx.fill();
    }

    // nối đường mờ giữa các hạt gần nhau
    ctx.lineWidth = 0.6*devicePixelRatio;
    ctx.strokeStyle = "rgba(255,255,255,0.20)";
    for(let i=0;i<particles.length;i++){
      for(let j=i+1;j<particles.length;j++){
        const a = particles[i], b = particles[j];
        const dx = a.x-b.x, dy = a.y-b.y;
        const d2 = dx*dx + dy*dy;
        if(d2 < (120*devicePixelRatio)**2){
          ctx.globalAlpha = 0.25;
          ctx.beginPath();
          ctx.moveTo(a.x, a.y);
          ctx.lineTo(b.x, b.y);
          ctx.stroke();
        }
      }
    }
    ctx.globalAlpha = 1;
    requestAnimationFrame(step);
  }
  step();
</script>
</body>
</html>
