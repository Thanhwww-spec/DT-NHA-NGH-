<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>B·∫£ng ƒëi·ªÅu khi·ªÉn DHT11 (3D)</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(145deg, #0f0f0f, #1c1c1c);
      color: #fff;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1 {
      background: #3b82f6;
      padding: 20px;
      margin: 0;
      font-size: 28px;
      border-radius: 0 0 25px 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }
    .status {
      margin: 15px;
      font-weight: bold;
      font-size: 20px;
    }
    .container {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 80px;
      margin: 40px 0;
      flex-wrap: wrap;
    }
    .column {
      width: 140px;
      height: 400px;
      background: #333;
      border-radius: 70px;
      position: relative;
      overflow: hidden;
      box-shadow: inset -6px -6px 12px rgba(255,255,255,0.1),
                  inset 6px 6px 18px rgba(0,0,0,0.7),
                  0 8px 25px rgba(0,0,0,0.8);
    }
    .fill {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 0%;
      transition: height 0.6s ease-in-out;
      border-radius: 70px;
      box-shadow: inset 0 0 25px rgba(255,255,255,0.3);
    }
    .fill.temp { background: linear-gradient(to top, #ff0000, #ff7f7f); }
    .fill.humi { background: linear-gradient(to top, #007bff, #7fbfff); }
    .label {
      margin-top: 15px;
      font-size: 22px;
      font-weight: bold;
    }
    .value {
      margin: 8px 0;
      font-size: 26px;
      font-weight: bold;
    }
    .card {
      background: #222;
      margin: 20px auto;
      padding: 25px;
      border-radius: 20px;
      width: 340px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.6);
    }
    .relay-btn {
      margin: 12px;
      padding: 12px 28px;
      font-size: 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      color: white;
      box-shadow: 0 5px 12px rgba(0,0,0,0.5);
      transition: transform 0.2s;
    }
    .relay-btn:hover { transform: scale(1.08); }
    .on { background: green; }
    .off { background: red; }

    /* Responsive cho mobile */
    @media (max-width: 600px) {
      .container { gap: 40px; margin: 20px 0; }
      .column { width: 120px; height: 300px; }
      .label { font-size: 18px; }
      .value { font-size: 22px; }
      .card { width: 90%; }
    }
  </style>
</head>
<body>
  <h1>B·∫£ng ƒëi·ªÅu khi·ªÉn DHT11 (3D)</h1>
  <div class="status" id="mqttStatus">üî¥ M·∫•t k·∫øt n·ªëi</div>

  <div class="container">
    <div>
      <div class="column"><div id="tempFill" class="fill temp"></div></div>
      <div class="label">üå° Nhi·ªát ƒë·ªô</div>
      <div class="value" id="tempValue">--</div>
    </div>
    <div>
      <div class="column"><div id="humiFill" class="fill humi"></div></div>
      <div class="label">üíß ƒê·ªô ·∫©m</div>
      <div class="value" id="humiValue">--</div>
    </div>
  </div>

  <div class="card">
    <h2>ƒêi·ªÅu khi·ªÉn Relay</h2>
    <div id="relayStatus">Tr·∫°ng th√°i: --</div>
    <button class="relay-btn on" id="btnOn">B·∫¨T</button>
    <button class="relay-btn off" id="btnOff">T·∫ÆT</button>
  </div>

  <script>
    // --- C·∫•u h√¨nh MQTT (Websocket HiveMQ) ---
    const options = {
      username: "thanh1996",
      password: "14121996Th",
      clean: true,
      connectTimeout: 4000,
      reconnectPeriod: 2000
    };
    const client = mqtt.connect("wss://21a3db3a20cb4f279935ea81af04ba01.s1.eu.hivemq.cloud:8884/mqtt", options);

    const mqttStatus = document.getElementById("mqttStatus");
    const tempValue = document.getElementById("tempValue");
    const humiValue = document.getElementById("humiValue");
    const relayStatus = document.getElementById("relayStatus");
    const tempFill = document.getElementById("tempFill");
    const humiFill = document.getElementById("humiFill");

    // --- K·∫øt n·ªëi MQTT ---
    client.on("connect", () => {
      mqttStatus.textContent = "üü¢ ESP Online";
      client.subscribe("esp8266/availability");
      client.subscribe("esp8266/dht11/temp");
      client.subscribe("esp8266/dht11/humi");
      client.subscribe("esp8266/relay1/status");
    });

    client.on("offline", () => {
      mqttStatus.textContent = "üî¥ M·∫•t k·∫øt n·ªëi";
      tempValue.textContent = "‚ùå L·ªói c·∫£m bi·∫øn";
      humiValue.textContent = "‚ùå L·ªói c·∫£m bi·∫øn";
      tempFill.style.height = "0%";
      humiFill.style.height = "0%";
    });

    // --- Nh·∫≠n d·ªØ li·ªáu ---
    client.on("message", (topic, message) => {
      const msg = message.toString();
      if (topic === "esp8266/availability") {
        mqttStatus.textContent = msg === "online" ? "üü¢ ESP Online" : "üî¥ ESP Offline";
        if (msg === "offline") {
          tempValue.textContent = "‚ùå L·ªói c·∫£m bi·∫øn";
          humiValue.textContent = "‚ùå L·ªói c·∫£m bi·∫øn";
          tempFill.style.height = "0%";
          humiFill.style.height = "0%";
        }
      }
      if (topic === "esp8266/dht11/temp") {
        if (msg === "error") {
          tempValue.textContent = "‚ùå L·ªói c·∫£m bi·∫øn";
          tempFill.style.height = "0%";
        } else {
          tempValue.textContent = msg + " ¬∞C";
          tempFill.style.height = Math.min(parseFloat(msg), 100) + "%";
        }
      }
      if (topic === "esp8266/dht11/humi") {
        if (msg === "error") {
          humiValue.textContent = "‚ùå L·ªói c·∫£m bi·∫øn";
          humiFill.style.height = "0%";
        } else {
          humiValue.textContent = msg + " %";
          humiFill.style.height = Math.min(parseFloat(msg), 100) + "%";
        }
      }
      if (topic === "esp8266/relay1/status") {
        relayStatus.textContent = "Tr·∫°ng th√°i: " + msg.toUpperCase();
      }
    });

    // --- ƒêi·ªÅu khi·ªÉn Relay ---
    document.getElementById("btnOn").onclick = () => {
      client.publish("esp8266/relay1", "on");
      relayStatus.textContent = "Tr·∫°ng th√°i: ON";
    };
    document.getElementById("btnOff").onclick = () => {
      client.publish("esp8266/relay1", "off");
      relayStatus.textContent = "Tr·∫°ng th√°i: OFF";
    };
  </script>
</body>
</html>
