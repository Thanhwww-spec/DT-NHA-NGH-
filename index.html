<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DHT11 Dashboard</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; background:#111; margin:0; color:#fff; }
    h1 { background:#3f51b5; padding:15px; margin:0; text-align:center; }

    /* --- Login screen --- */
    #loginScreen {
      display:flex; justify-content:center; align-items:center;
      height:100vh; background:linear-gradient(135deg,#1a1a1a,#333);
      perspective:1000px;
    }
    .login-box {
      background:#222; padding:40px; border-radius:20px;
      box-shadow:0 10px 30px rgba(0,0,0,0.6);
      transform:rotateY(10deg); transition:transform 0.6s;
    }
    .login-box:hover { transform:rotateY(0deg); }
    .login-box h2 { margin-bottom:20px; color:#4cafef; }
    .login-box input {
      width:100%; padding:12px; margin:10px 0;
      border:none; border-radius:8px; font-size:16px;
    }
    .login-box button {
      width:100%; padding:12px; margin-top:10px;
      background:#4caf50; border:none; border-radius:8px;
      font-size:18px; font-weight:bold; cursor:pointer; color:#fff;
    }

    /* --- Dashboard --- */
    #dashboard { display:none; text-align:center; padding:20px; }

    .status { margin:15px; font-weight:bold; }
    .cards { display:flex; justify-content:center; gap:40px; margin-top:20px; }
    .card {
      background:#222; padding:20px; border-radius:15px;
      box-shadow:0 4px 15px rgba(0,0,0,0.5); width:180px;
    }
    .label { font-size:20px; font-weight:bold; margin-bottom:10px; }
    .temp { color:#ff5252; }
    .humi { color:#2196f3; }
    .value { font-size:28px; font-weight:bold; }

    /* --- 3D tubes --- */
    .tubes { display:flex; justify-content:center; gap:60px; margin:30px 0; }
    .tube {
      width:60px; height:200px; border-radius:30px;
      background:linear-gradient(#444,#222);
      border:3px solid #555; position:relative;
      overflow:hidden; box-shadow:inset 0 0 15px rgba(0,0,0,0.8);
    }
    .fill {
      position:absolute; bottom:0; width:100%;
      border-radius:30px;
      transition:height 0.5s;
    }
    .temp-fill { background:linear-gradient(to top,#ff0000,#ff8080); }
    .humi-fill { background:linear-gradient(to top,#0080ff,#80c0ff); }

    /* --- Relay --- */
    .relay { margin-top:30px; }
    .btn {
      font-size:18px; padding:12px 25px; margin:10px;
      border:none; border-radius:10px; cursor:pointer;
      color:#fff; font-weight:bold;
    }
    .on { background:#22c55e; }
    .off { background:#ef4444; }

    /* --- Chart --- */
    .chart-container {
      width:90%; max-width:800px; margin:30px auto;
      background:#222; padding:20px; border-radius:15px;
      box-shadow:0 4px 15px rgba(0,0,0,0.5);
    }
  </style>
</head>
<body>
  <!-- Login -->
  <div id="loginScreen">
    <div class="login-box">
      <h2>üîê ƒêƒÉng nh·∫≠p</h2>
      <input type="password" id="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
      <button onclick="checkLogin()">ƒêƒÉng nh·∫≠p</button>
      <p id="loginError" style="color:red; display:none;">‚ùå Sai m·∫≠t kh·∫©u!</p>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard">
    <h1>DHT11 Dashboard</h1>
    <div class="status" id="status">üî¥ Ch∆∞a k·∫øt n·ªëi MQTT</div>

    <div class="cards">
      <div class="card">
        <div class="label temp">üåû Nhi·ªát ƒë·ªô</div>
        <div class="value" id="temp">--</div>
      </div>
      <div class="card">
        <div class="label humi">‚ùÑÔ∏è ƒê·ªô ·∫©m</div>
        <div class="value" id="humi">--</div>
      </div>
    </div>

    <!-- ·ªêng 3D -->
    <div class="tubes">
      <div class="tube"><div class="fill temp-fill" id="tempFill" style="height:0%"></div></div>
      <div class="tube"><div class="fill humi-fill" id="humiFill" style="height:0%"></div></div>
    </div>

    <!-- Relay -->
    <div class="relay">
      <h2>ƒêi·ªÅu khi·ªÉn Relay</h2>
      <button class="btn on" id="btnOn">B·∫¨T</button>
      <button class="btn off" id="btnOff">T·∫ÆT</button>
      <p>Tr·∫°ng th√°i relay: <span id="relayStatus">‚è≥ Ch∆∞a r√µ</span></p>
    </div>

    <!-- Chart -->
    <div class="chart-container">
      <h2>L·ªãch s·ª≠ Nhi·ªát ƒë·ªô & ƒê·ªô ·∫©m</h2>
      <canvas id="dhtChart"></canvas>
    </div>
  </div>

  <script>
    const PASSWORD = "1234"; // ‚úÖ ƒê·ªïi m·∫≠t kh·∫©u t·∫°i ƒë√¢y

    function checkLogin(){
      const pass=document.getElementById("password").value;
      if(pass===PASSWORD){
        document.getElementById("loginScreen").style.display="none";
        document.getElementById("dashboard").style.display="block";
        startMQTT();
      } else {
        document.getElementById("loginError").style.display="block";
      }
    }

    // ================== Dashboard Script ==================
    let client, tempEl, humiEl, relayStatusEl, tempFill, humiFill;
    let latestTemp=null, latestHumi=null;

    function startMQTT(){
      tempEl=document.getElementById("temp");
      humiEl=document.getElementById("humi");
      relayStatusEl=document.getElementById("relayStatus");
      tempFill=document.getElementById("tempFill");
      humiFill=document.getElementById("humiFill");

      const options = {
        username:"thanh1996",
        password:"14121996Th",
        protocol:"wss", port:8884,
        clientId:"webClient_"+Math.random().toString(16).substr(2,8)
      };
      const host="wss://21a3db3a20cb4f279935ea81af04ba01.s1.eu.hivemq.cloud:8884/mqtt";
      client=mqtt.connect(host,options);

      const statusEl=document.getElementById("status");

      // Chart
      const ctx=document.getElementById("dhtChart").getContext("2d");
      const maxPoints=20;
      const dhtChart=new Chart(ctx,{
        type:"line",
        data:{ labels:[], datasets:[
          {label:"Nhi·ªát ƒë·ªô (¬∞C)",borderColor:"red",data:[],fill:false},
          {label:"ƒê·ªô ·∫©m (%)",borderColor:"blue",data:[],fill:false}
        ]},
        options:{ responsive:true,animation:false,
          scales:{ x:{title:{display:true,text:"Th·ªùi gian"}}, y:{beginAtZero:true} }
        }
      });

      function addData(t,h){
        const now=new Date().toLocaleTimeString();
        if(dhtChart.data.labels.length>=maxPoints){
          dhtChart.data.labels.shift();
          dhtChart.data.datasets[0].data.shift();
          dhtChart.data.datasets[1].data.shift();
        }
        dhtChart.data.labels.push(now);
        dhtChart.data.datasets[0].data.push(t);
        dhtChart.data.datasets[1].data.push(h);
        dhtChart.update();
      }

      client.on("connect",()=>{
        statusEl.textContent="üü¢ ƒê√£ k·∫øt n·ªëi MQTT";
        client.subscribe("esp8266/dht11/temp");
        client.subscribe("esp8266/dht11/humi");
        client.subscribe("esp8266/relay1/status");
      });

      client.on("error",(err)=>{
        statusEl.textContent="‚ùå L·ªói k·∫øt n·ªëi: "+err;
      });

      client.on("message",(topic,message)=>{
        const msg=message.toString();

        if(topic==="esp8266/dht11/temp"){
          if(msg==="error"){
            tempEl.textContent="‚ö†Ô∏è L·ªói c·∫£m bi·∫øn";
            tempFill.style.height="0%";
            latestTemp=null;
          } else {
            tempEl.textContent=msg+"¬∞C";
            latestTemp=parseFloat(msg);
            tempFill.style.height=Math.min(100,(latestTemp/50*100))+"%";
          }
        }

        if(topic==="esp8266/dht11/humi"){
          if(msg==="error"){
            humiEl.textContent="‚ö†Ô∏è L·ªói c·∫£m bi·∫øn";
            humiFill.style.height="0%";
            latestHumi=null;
          } else {
            humiEl.textContent=msg+"%";
            latestHumi=parseFloat(msg);
            humiFill.style.height=Math.min(100,latestHumi)+"%";
          }
        }

        if(topic==="esp8266/relay1/status"){
          relayStatusEl.textContent=msg;
        }

        if(latestTemp!==null && latestHumi!==null){
          addData(latestTemp,latestHumi);
          latestTemp=latestHumi=null;
        }
      });

      // Relay control
      document.getElementById("btnOn").addEventListener("click",()=>client.publish("esp8266/relay1","on"));
      document.getElementById("btnOff").addEventListener("click",()=>client.publish("esp8266/relay1","off"));
    }
  </script>
</body>
</html>
